---
title: "Sample Size Calcualtion for the Cochran-Mantel-Haenszel Test"
author: 
  "Paul W. Egeler, M.S., GStat"
date: "`r Sys.Date()`"
output: word_document
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Sample Size Calcualtion for the Cochran-Mantel-Haenszel Test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!-- 
May someday want output: 
  pdf_document 
  rmarkdown::html_vignette
  word_document
-->

## Introduction

The **Cochran-Mantel-Haenszel test** (CMH) is an inferential test for the association between two binary variables, while controlling for a third confounding nominal variable. Two variables of interest, $X$ and $Y$, are compared at each level of the confounder variable $Z$ and the results are combined, creating a common odds ratio. Essentially, the CMH test examines the *weighted* association of $X$ and $Y$. The CMH test is a common technique in the field of biostatistics, where it is often used for case-control studies.

Researchers interested in estimating the probability of detecting a true positive result from an inferential test must perform a power calculation using a known sample size, effect size, significance level, *et cetera*. Likewise, given a target power which the researcher would like to achieve, a calculation can be performed in order to estimate the appropriate number of subjects for a study. We are not aware of any other R packages, or indeed any free and open source software tools that will achieve these calculations for the CMH test. Hence the imperative to create such a package to fill the small gap in R's considerable suite of statistical capabilities.

## Background

### Partial and Marginal Tables

Consider a contingency table comparing $X$ and $Y$ at some fixed level of $Z$. These cross-sections of the three-way table at each level of $Z$ are called *partial tables*. The combined counts of $X$ and $Y$ across all levels of $Z$, *id est* a simple two-way contingency table ignoring $Z$, produce the *marginal table*. These concepts are described in depth in @Agresti [section 2.7.1]. 

---

We will use the `Titanic`{.r} dataset in the `datasets`{.r} package to illustrate. This dataset is a four-dimensional table which includes the *Class* (1^st^, 2^nd^, 3^rd^, Crew), *Sex* (Male, Female), *Age* (Child, Adult), and *Survival* (No, Yes) of the passengers of the 1912 maritime disaster. Use `help("Titanic", "datasets")`{.r} to find more information.

```{r load-data}
data(Titanic, package = "datasets")
str(Titanic)
```

Let $X$ = sex, $Y$ = survival, and $Z$ = class. We will load in the data and look at suvival by sex at each level of class using the `margin.table()` function in the `base` package.

```{r partial-tables}
partial_tables <- margin.table(Titanic, c(2,4,1))
partial_tables
```

Each of the tables above is a partial table: *survival by sex at a fixed level of class*. The tables can be flattened for easier viewing using the `ftable()`{.r} function in the `stats`{.r} package.

The code below shows the marginal table of survival by sex, ignoring class.

```{r marginal-table}
marginal_table <- margin.table(Titanic, c(2,4))
marginal_table
```

We may get the table proportions using the `prop.table()`{.r} function. Because the `Titanic`{.r} dataset is a multidimensional table, it must first be transformed into a two-dimensional table using `margin.table()`{.r} (as performed above).

```{r prop-table}
prop.table(marginal_table)
```

### Conditional, Marginal, and Common Odds Ratios

In comparing variables $X$ and $Y$ at a fixed $j$ level of $Z$, we may use a *conditional odds ratio*, described by @Agresti [section 2.7.4]. We will denote it as $\theta_{XY(j)}$. The *marginal odds ratio* would then refer to the odds ratio of $X$ and $Y$ generated by the marginal table. It follows that the marginal odds ratio would be denoted by $\theta_{XY}$.

An odds ratio estimate ($\hat\theta$) can be calculated from a table or matrix using the `samplesizeCMH`{.r} package using the `odds.ratio()`{.r} function. The `odds.ratio()`{.r} function can take either a table of frequencies or percents, as they are algebraicly equivalent, as demonstrated below. 

Using proportions, we see how the ratio of the row odds $o_1$ and $o_2$ are estimated.

$$
\hat{\theta}= 
\frac{\hat{o}_1}{\hat{o}_2} = 
\frac{\hat{\pi}_{11} / \hat{\pi}_{12}}{\hat{\pi}_{21} / \hat{\pi}_{22}} =
\frac{\hat{\pi}_{11}\hat{\pi}_{22}}{\hat{\pi}_{12}\hat{\pi}_{21}}.
$$

And since row odds estimates are related to cell counts through the following,

$$
\hat{o} = 
\frac{\hat{\pi}_1}{1 - \hat{\pi}_1} = 
\frac{\hat{\pi}_1}{\hat{\pi}_2} = 
\frac{n_1 / n_+}{n_2 / n_+} =
\frac{n_1}{n_2},
$$

the odds estimate, defined as $\frac{\hat{\pi}_1}{\hat{\pi}_2}$, is equivalent to $\frac{n_1}{n_2}$. Therefore, 

$$
\hat{\theta}= 
\frac{\hat{\pi}_{11}\hat{\pi}_{22}}{\hat{\pi}_{12}\hat{\pi}_{21}} = 
\frac{n_{11}n_{22}}{n_{12}n_{21}}.
$$

---

Let's first look at the marginal odds ratio of survival by sex using the Titanic data.

```{r marginal-OR}
library(samplesizeCMH)

odds.ratio(marginal_table)
```

The conditional odds ratios can be calculated using the partial tables.

```{r conditional-OR}
apply(partial_tables, 3, odds.ratio)
```

Obviously this is more informative than a simple marginal odds ratio. Based on what we see above, survival by sex appears to vary widely by class, where women in 1^st^ class survive at a much higher rate than men, whereas 3^rd^ class women had only slightly better chance of survival than their male counterparts.

We can produce a *common (weighted) odds ratio* using `mantelhaen.test()`{.r} from the `stats`{.r} package. Note that it differs slightly from the marginal odds ratio above since it takes into account the differential sizes of each partial table.

```{r mantelhaen}
library(stats)

mantelhaen.test(partial_tables)
```

### Conditional and Marginal Association/Independence

The term *conditional association* refers to the association of the $X$ and $Y$ variables conditional on the level of $Z$. Likewise, the *marginal association* refers to the overall association between $X$ and $Y$ while ignoring $Z$. 

The finding of conditional association does not imply marginal association, nor vice-versa. The use of the CMH test to control for the stratifying variable in analysis serves to avoid the well-documented phenomenon of the Simpson's Paradox in which statistical significance may be found when considering the association between two variables, but where no such significance may be found after considering the stratification. Likewise, the reverse situation may arise where no association may be found between the binary variables, but may be observed when the third variable is introduced.

Refer to @Agresti [section 2.7.3] for more information on the content of this section.

### Homogeneous Association/Independence

*Homogeneous independence* is when all the odds ratios between binary variables $X$ and $Y$ are equal for all $j$ levels of variable $Z$, such that $$\theta_{XY(1)}=\theta_{XY(2)}=...=\theta_{XY(j)}.$$ [@Agresti section 2.7.6]

The Breslow-Day test can be used to check the null hypothesis that all odds ratios are equal. The Cochran-Mantel-Haenszel test is a special case of the Breslow-Day test wherein the common odds ratio is assumed to be 1. Using the `Titanic` data, we can perform the Breslow-Day test using `BreslowDayTest()`{.r} from the `DescTools`{.r} package.

```{r BreslowDay}
library(DescTools)

BreslowDayTest(x = partial_tables, OR = 1)
```

Note the near agreement with the output from `mantelhaen.test()`{.r} from the section above.


<!--
### Case-Control Studies

In case-control studies, . 
-->

## Power Calculation

Using the `Titanic` dataset above, we may calculate the power of the inference of the Mantel-Haenzel test using the calculations put forth by @Wittes1987.

*`power.cmh()`{.r} Under construction*

## Sample Size

The first method to estimate sample size for the CMH test was introduced by @Gail1973 using a least squares method. @Munoz1984 later produced a sample size estimator useful in the special case when both margins are fixed. However, this is often not the case in retrospective case-control designs. As such, @Woolson1986 introduced a calculation using the weighted difference between two binomial distributions. This was corroborated with @Wittes1987 in their paper a year later. Later still, @Nam1992 improved upon that calculation by introducing a coefficient to address continuity corrected CMH tests.

### The Research Question

<!--
Let us consider a study where a researcher would like to retrospectively compare the postoperative infection rate associated with two commonly used medical implants. The study could randomly select a fixed number of patients based on the medical device implanted and then infection status could be observed. 

Since the researcher is part of a regional health system, she may have access to data from several hospitals. Inclusion of the data from several hospitals could be a boon to the study since it can increase sample size and make the findings more generalizable. However, introducing the hospital variable may be considered a confounder and should be addressed appropriately. Of the three hospitals that perfrom the implantation procedure, the researcher estimates that the central hospital performs about 50% of the procedures, and the other two are split evenly with the remainder. Therefore, $t_1$ = 0.50, $t_2$ = 0.25, and $t_3$ = 0.25.

Initial investigation shows that the central hospital uses device A at a rate of 0.75, 
-->

Starting with the example first used by @Woolson1986 and then revisited by @Nam1992, we will explore the usage of the central function of the `samplesizeCMH`{.r} package, the `samplesize.cmh()`{.r} function.

This was a case--control study which looked at whether there was an association between colon cancer and chlorinated drinking water among males in Iowa. There were four age categories, 20--54 years, 55--69 years, 70--79 years, and 80--84 years; therefore $J$ = 4. The relative proportion of each age group to the total sample is as follows: $t_1$ = 0.10, $t_2$ = 0.40, $t_3$ = 0.35, and $t_4$ = 0.15. The National Collaborative Bladder Cancer Study showed that exposure rate from controls for each age stratum, denoted by $\pi_{2j}$ (where $j$ is the stratum), was $\pi_{21}$ = 0.75, $\pi_{22}$ = 0.70, $\pi_{23}$ = 0.65, and $\pi_{24}$ = 0.60. Level of significance was set at 0.05 and desired power was 90% with an effect size of 3. They matched equal number of cases and controls in each stratum, *i.e.*, $s_1=s_2=s_3=s_4=$ 0.5.

### Calculating Sample Size

#### Methods 

We will go over several calculation methods to compare the usage of the `samplesize.cmh()`{.r} function for different data sets and experimental designs.

##### Unstratified

Suppose that the researchers first decided to ignore the stratification variable in their sample size calculation. The researcher could use the `method = "unstratified"`{.r} argument. We see that the researcher has put in the control exposure proportions as a vector (`p2`), the effect size has been given (`theta`), and a vector of relative stratum sizes has been assigned (`t`). Since there are equal numbers of cases and controls for each group, the `s` parameter is not required. Only `p1` and `p2` *or* one of the proportions and a `theta` are required to carry out the calculation. The number of strata ($J$) is inferred from the maximum vector length of `p1`, `p2`, or `theta`.

```{r unstratified}
sample_size_unstratified <- samplesize.cmh(
  p2 = c(0.75,0.70,0.65,0.60),
  theta = 3,
  power = 0.9,
  t = c(0.10,0.40,0.35,0.15),
  alternative = "one",
  method = "unstratified"
)

sample_size_unstratified
```

##### Weighted Difference between Binomial Distributions

The researcher soon realized that failing to consider the confounding variable tends to lead to an underestimation of sample size. Adjusting the code above, an alteration is made to the `method` parameter, now using the calculation introduced by @Woolson1986. Note that the `"binomial"`{.r} option has been abbreviated.

```{r binomial}
# Uncorrected sample size estimate first introduced
# by Woolson and others in 1986
sample_size_binomial <- samplesize.cmh(
  p2 = c(0.75,0.70,0.65,0.60),
  theta = 3,
  power = 0.9,
  t = c(0.10,0.40,0.35,0.15),
  alternative = "one",
  method = "bin"
)

sample_size_binomial
```

In this case, the sample size has decreased slightly with this new calculation method. Meaning that the unstratified calcuation slightly overestimated sample size with respect to the formula proposed by @Woolson1986. 

##### Continuity Corrected Estimate

The researcher now realizes that a continuity correction would be appropriate when perfroming the CMH test (the default of the `mantaelhaen.test()`{.r} is `correct = TRUE`{.r}). Another adjustment is made to the `method` parameter in the code below to take continuity correction into account.

```{r cc}
# Continuity corrected sample size estimate added by Nam
sample_size_corrected <- samplesize.cmh(
  p2 = c(0.75,0.70,0.65,0.60),
  theta = 3,
  power = 0.9,
  t = c(0.10,0.40,0.35,0.15),
  alternative = "one",
  method = "cc.bin"
)

sample_size_corrected
```

We see that the `N.exact` is indeed equal to that which is reported in the paper by @Nam1992.

```{r cc2}
sample_size_corrected$N.exact
```

#### Unequal Numbers of Cases and Controls

Consider now that the researcher performed some preparatory work and realized that the number of cases available is about $\frac{1}{3}$ the number of available controls. Wanting to leverage all of the available data, an adjustment was be made to the sample size calculation performed earlier by including the `s` parameter.

```{r s}
samplesize.cmh(
  p2 = c(0.75,0.70,0.65,0.60),
  s = 1/3,
  theta = 3,
  power = 0.9,
  t = c(0.10,0.40,0.35,0.15),
  alternative = "one",
  method = "cc.bin"
)
```


### A Closer Look at a Partial Table

Let's take a moment to look at the partial table of stratum $j$ = 1. Given the information above, we can reconstruct this table to better understand the question at hand. We can also use this as an opportunity to use some of the peripheral functions included in the `samplesizeCMH`{.r} package.

The proportion of controls exposed to chlorinated drinking water was $\pi_{21}$ = 0.75. It follows then that the complementary column proportion is 0.25. The table below shows column percents.


|           |Case | Control |
------------|:---:|:-------:|
Exposed     | ?   | 0.75
Not Exposed | ?   | 0.25
 
Using the `effect.size()`{.r} function, we can use the expected exposure rate of control to estimate expected exposure rate of cases.

```{r effect-size}
effect.size(0.75,3)
```

We can now use that to fill in the remainder of our table.

|           |Case | Control |
------------|:---:|:-------:|
Exposed     | 0.90| 0.75
Not Exposed | 0.10| 0.25

To determine the odds of exposure for the two groups, we can use `prop2odds()`{.r}.

```{r prop2odds}
# Control
prop2odds(0.75)

# Case
prop2odds(0.9)
```

We can also use either row or column proportions to calculate the odds ratio for a 2 $\times$ 2 table.

```{r props2theta}
props2theta(0.90,0.75)
```

There are several other peripheral functions in this package to interconvert between proportions, odds, relative risk, and odds ratios. Use `help("odds.and.proportions", "samplesizeCMH")`{.r} to find out more.

## Conclusion

## References
