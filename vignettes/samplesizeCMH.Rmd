---
title: "Sample Size Calcualtion for the Cochran-Mantel-Haenszel Test"
author: 
  "Paul W. Egeler, M.S., GStat and Laura Kapitula, PhD"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Sample Size Calcualtion for the Cochran-Mantel-Haenszel Test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- Example of Bibliographic citation:

[@Agresti section 2.7; @Nam1992]

Use the refs.bib to find reference label

-->

## Introduction

The **Cochran-Mantel-Haenszel test** (CMH) is an inferential test for the association between two binary variables, while controlling for a third confounding nominal variable. Two variables of interest, $X$ and $Y$, are compared at each level of the confounder variable $Z$. Essentially, the CMH test examines the *weighted* association of $X$ and $Y$. The CMH test is a common technique in the field of biostatistics, where it is often used for case-control studies.

We are not aware of any other R packages, or indeed any free and open source software tools that will achieve these calculations. Hence the imperative to create such a package to fill the small gap in R's considerable suite of statistical capabilities.

## Background

### Partial and Marginal Tables

Consider a contingency table comparing $X$ and $Y$ at some fixed level of $Z$. These cross-sections of the three-way table at each level of $Z$ are called *partial tables*. The combined counts of $X$ and $Y$ across all levels of $Z$, *id est* a simple two-way contingency table ignoring $Z$, produce the *marginal table*. These concepts are described in depth in @Agresti [section 2.7.1]. 

We will use the `Titanic` dataset in the `datasets` package to illustrate. This dataset is a four-dimensional table which includes the *Class* (1^st^, 2^nd^, 3^rd^, Crew), *Sex* (Male, Female), *Age* (Child, Adult), and *Survival* (No, Yes) of the passengers of the 1912 maritime disaster. Use `help("Titanic", "datasets")` to find more information.

```{r load-data}
data(Titanic, package = "datasets")
```

Let $X$ = sex, $Y$ = survival, and $Z$ = class. We will load in the data and look at suvival by sex at each level of class using the `margin.table()` function.

```{r partial-tables}
partial_tables <- margin.table(Titanic, c(2,4,1))
partial_tables
```

Each of the tables above is a partial table of survival by sex at a fixed level of class. The table can be flattened for easier viewing using the `ftable()` function.

The code below shows the marginal table of survival by sex, ignoring class.

```{r marginal-table}
marginal_table <- margin.table(Titanic, c(2,4))
marginal_table
```

We may get the table proportions using the `prop.table()` function. Because the `Titanic` dataset is a multidimensional table, it must first be transformed into a two-dimensional table using `margin.table()`.

```{r prop-table}
prop.table(marginal_table)
```

### Conditional and Marginal Odds Ratios

In comparing variables $X$ and $Y$ at a fixed $k$ level of $Z$, we may use a *conditional odds ratio*, denoted by @Agresti [section 2.7.4] as $\theta_{XY(k)}$. The *marginal odds ratio* would then refer to the odds ratio of $X$ and $Y$ generated by the marginal table. 

The odds ratios can be calculated from a table or matrix using the `samplesizeCMH` package using the `odds.ratio()` function. Let's first look at the marginal odds ratio of survival by sex.

```{r marginal-OR}
library(samplesizeCMH)

odds.ratio(marginal_table)
```

The conditional odds ratios can be calculated using the partial tables.

```{r conditional-OR}
apply(partial_tables, 3, odds.ratio)
```

Obviously this is more informative than a simple marginal odds ratio. Based on what we see above, survival by sex appears to vary widely by class, where women in 1^st^ class survive at a much higher rate than men, whereas 3^rd^ class women had only slightly better change of survival than their male counterparts.

We can produce a common (weighted) odds ratio using `mantelhaen.test()` from the `stats` package. Note that it differs slightly from the marginal odds ratio above since it takes into account the differential sizes of each partial table.

```{r mantelhaen}
library(stats)

mantelhaen.test(partial_tables)
```

### Conditional and Marginal Association/Independence

The term *conditional association* refers to the association of the $X$ and $Y$ variables conditional on the level of $Z$. Likewise, the *marginal association* refers to the overall association between $X$ and $Y$ while ignoring $Z$. 

The finding of conditional association does not imply marginal association, nor vice-versa. The use of the CMH test to control for the stratifying variable in analysis serves to avoid the well-documented phenomenon of the Simpson's Paradox in which statistical significance may be found when considering the association between two variables, but where no such significance may be found after considering the stratification. Likewise, the reverse situation may arise where no association may be found between the binary variables, but may be observed when the third variable is introduced.

Refer to @Agresti [section 2.7] for more information on the content of this section.

### Case-Control Studies

In case-control studies, . 

<!-- I would like to include some calculations and further explanation of the CMH test here. It would also be nice to discuss case-control studies. Would also like to explore the `mantelhaen.test()` function breifly and use the same examples (also from Agresti) as our base examples. -->

## Sample Size

### Theory

Show what we know

### Calculation


```{r test}
library(samplesizeCMH)

# Continuity corrected sample size estimate added by Nam
sample_size_corrected <- samplesize.cmh(
  p2 = c(0.75,0.70,0.65,0.60),
  theta = 3,
  power = 0.9,
  t = c(0.10,0.40,0.35,0.15),
  alternative = "one",
  method = "cc.bin"
)

sample_size_corrected

# We see that the N.exact is indeed equal to that which is reported in the paper
sample_size_corrected$N.exact
```

## References
